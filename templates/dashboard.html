{% extends "base.html" %}

{% block content %}
<style>
    /* --- Layout Split-Screen Profesional --- */
    body { overflow: hidden; background: #0f172a; }
    
    .app-container {
        display: flex;
        height: 100vh;
        padding-top: 50px; /* Navbar space */
    }

    /* PANE IZQUIERDO: GRAFO (Inmersivo) */
    .pane-graph {
        flex: 6; /* 60% width */
        background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        position: relative;
        border-right: 1px solid #334155;
    }

    /* PANE DERECHO: INTERACCIÓN (Papel/Utilidad) */
    .pane-sidebar {
        flex: 4; /* 40% width */
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        box-shadow: -5px 0 25px rgba(0,0,0,0.2);
        z-index: 20;
    }

    /* --- Navbar Minimalista --- */
    .navbar-glass {
        height: 50px;
        background: #0f172a;
        border-bottom: 1px solid #334155;
        z-index: 50;
    }
    .brand-text { font-family: 'Outfit', sans-serif; letter-spacing: -0.5px; }

    /* --- Graph HUD --- */
    .graph-hud {
        position: absolute;
        top: 20px; left: 20px;
        background: rgba(15, 23, 42, 0.85);
        backdrop-filter: blur(8px);
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
        color: #e2e8f0;
        font-size: 0.8rem;
        pointer-events: none; /* Click through */
        user-select: none;
    }
    
    /* --- Chat UI --- */
    .chat-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f1f5f9;
        scroll-behavior: smooth;
    }

    .message-card {
        margin-bottom: 1.5rem;
        animation: fadeIn 0.3s ease-out;
    }
    
    .message-user {
        background: #3b82f6;
        color: white;
        padding: 1rem;
        border-radius: 16px 16px 2px 16px;
        margin-left: 2rem;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
    }

    .message-ai {
        background: white;
        border: 1px solid #e2e8f0;
        padding: 1.5rem;
        border-radius: 16px 16px 16px 2px;
        margin-right: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        color: #334155;
    }

    /* Citas Interactivas */
    .citation-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px; height: 20px;
        background: #e0e7ff;
        color: #4f46e5;
        border-radius: 50%;
        font-size: 10px;
        font-weight: bold;
        margin: 0 2px;
        cursor: pointer;
        border: 1px solid #c7d2fe;
        transition: all 0.2s;
        vertical-align: super;
    }
    .citation-badge:hover {
        background: #4f46e5; color: white; transform: scale(1.2);
    }
    
    /* Fuente de Markdown */
    .md-content p { margin-bottom: 0.8rem; line-height: 1.6; }
    .md-content strong { color: #0f172a; font-weight: 700; }
    .md-content ul { padding-left: 1.2rem; }

    /* Tabs Sidebar */
    .nav-tabs-custom .nav-link {
        border: none;
        color: #64748b;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 1rem;
        border-bottom: 2px solid transparent;
    }
    .nav-tabs-custom .nav-link.active {
        color: #3b82f6;
        background: transparent;
        border-bottom-color: #3b82f6;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<!-- NAVBAR -->
<nav class="navbar navbar-dark navbar-glass fixed-top px-3 d-flex justify-content-between">
    <div class="d-flex align-items-center gap-2">
        <i class="fa-solid fa-draw-polygon text-primary"></i>
        <span class="brand-text fw-bold text-white">LaMuralla <span class="opacity-50 fw-light">Enterprise</span></span>
    </div>
    <div class="d-flex gap-3 text-xs text-muted">
        <span><i class="fa-solid fa-server me-1"></i> {{ config.model_name }}</span>
        <span><i class="fa-solid fa-circle text-success me-1"></i> Live</span>
        <a href="/logout" class="text-secondary"><i class="fa-solid fa-power-off"></i></a>
    </div>
</nav>

<!-- MAIN CONTAINER -->
<div class="app-container">
    
    <!-- LEFT: GRAPH ENGINE -->
    <div class="pane-graph">
        <!-- HUD Overlay -->
        <div class="graph-hud">
            <div class="mb-2 fw-bold text-uppercase tracking-wider opacity-75">Ontología</div>
            <div class="d-flex align-items-center gap-2 mb-1">
                <span class="d-inline-block rounded-circle" style="width:8px; height:8px; background:#6366f1; box-shadow: 0 0 5px #6366f1;"></span> Entidad
            </div>
            <div class="d-flex align-items-center gap-2 mb-1">
                <span class="d-inline-block rounded-circle" style="width:8px; height:8px; background:#f59e0b; box-shadow: 0 0 5px #f59e0b;"></span> Concepto
            </div>
            <div class="d-flex align-items-center gap-2 mb-1">
                <span class="d-inline-block rounded-circle" style="width:8px; height:8px; background:#ef4444;"></span> Inferencia
            </div>
            <hr class="border-secondary opacity-25 my-2">
            <div class="text-xs text-muted">
                <i class="fa-solid fa-mouse me-1"></i> Doble clic: Focalizar<br>
                <i class="fa-solid fa-hand-pointer me-1"></i> Hover Cita: Iluminar
            </div>
        </div>

        <!-- Vis.js Container -->
        <div id="network-container" style="width: 100%; height: 100%;"></div>
        
        <!-- Controls -->
        <div class="position-absolute bottom-0 end-0 p-3 d-flex gap-2">
            <button class="btn btn-dark btn-sm border border-secondary" onclick="network.fit({animation:true})">
                <i class="fa-solid fa-compress"></i>
            </button>
            <button class="btn btn-dark btn-sm border border-secondary" onclick="reloadGraph()">
                <i class="fa-solid fa-rotate"></i>
            </button>
        </div>
    </div>

    <!-- RIGHT: WORKSTATION -->
    <div class="pane-sidebar">
        <!-- Tabs -->
        <ul class="nav nav-tabs nav-tabs-custom px-3 bg-white border-bottom" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-chat">Asistente</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ingest">Ingesta</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-details">Detalles</button></li>
        </ul>

        <div class="tab-content flex-grow-1 overflow-hidden d-flex flex-column">
            
            <!-- 1. CHAT TAB -->
            <div class="tab-pane fade show active h-100 d-flex flex-column" id="tab-chat">
                <div id="chatArea" class="chat-history">
                    <div class="message-card message-ai">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="fa-solid fa-robot text-primary"></i>
                            <span class="fw-bold text-xs text-uppercase tracking-wide text-muted">Sistema</span>
                        </div>
                        <div class="md-content text-sm">
                            Hola. Soy tu motor de razonamiento gráfico. Hazme preguntas sobre tus documentos y te mostraré las conexiones ocultas.
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-white border-top">
                    <div class="position-relative">
                        <textarea id="userPrompt" class="form-control bg-light border-0 ps-3 pe-5 py-3 shadow-inner" 
                            rows="2" placeholder="Pregunta algo complejo..." style="resize: none; border-radius: 12px;"
                            onkeypress="handleEnter(event)"></textarea>
                        <button class="btn btn-primary position-absolute bottom-0 end-0 m-2 rounded-circle" 
                            style="width: 36px; height: 36px;" onclick="sendChat()">
                            <i class="fa-solid fa-paper-plane fa-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. INGEST TAB -->
            <div class="tab-pane fade p-4 overflow-auto" id="tab-ingest">
                <h6 class="fw-bold text-dark mb-3">Nuevo Conocimiento</h6>
                
                <div class="card border-0 bg-light mb-3">
                    <div class="card-body">
                        <label class="text-xs fw-bold text-muted mb-2">TEXTO RAW / MARKDOWN</label>
                        <textarea id="ingestContent" class="form-control mb-3 text-sm" rows="5"></textarea>
                        
                        <label class="text-xs fw-bold text-muted mb-2">O SUBIR ARCHIVO</label>
                        <input type="file" id="ingestFile" class="form-control form-control-sm mb-3">
                        
                        <button onclick="startIngestion()" id="btnIngest" class="btn btn-dark w-100 btn-sm fw-bold">
                            <i class="fa-solid fa-upload me-2"></i>PROCESAR
                        </button>
                    </div>
                </div>

                <div id="progressArea" class="d-none">
                    <div class="progress mb-2" style="height: 4px;">
                        <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                    <div id="progressLog" class="font-mono text-xs text-muted" style="max-height: 100px; overflow-y: auto;"></div>
                </div>

                <hr class="my-4">
                
                <h6 class="fw-bold text-dark mb-3">Motor de Inferencia</h6>
                <div class="p-3 bg-warning bg-opacity-10 rounded border border-warning border-opacity-25">
                    <p class="text-xs text-dark mb-3">Ejecutar análisis lógico para encontrar relaciones transitivas.</p>
                    <button onclick="runReasoning()" id="btnReasoning" class="btn btn-outline-dark w-100 btn-sm">
                        <i class="fa-solid fa-wand-magic-sparkles me-2"></i>CONSOLIDAR
                    </button>
                    <div id="reasoningResult" class="mt-2 text-xs fw-bold"></div>
                </div>
            </div>

            <!-- 3. DETAILS TAB -->
            <div class="tab-pane fade p-4" id="tab-details">
                <div id="details-placeholder" class="text-center text-muted mt-5">
                    <i class="fa-regular fa-object-ungroup fs-1 mb-3 opacity-50"></i>
                    <p class="text-sm">Selecciona un nodo o una cita para ver detalles profundos.</p>
                </div>
                <div id="details-content" class="d-none">
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <span class="badge bg-primary rounded-pill" id="detail-type">ENTITY</span>
                        <h5 class="fw-bold m-0" id="detail-title">Title</h5>
                    </div>
                    <div class="card bg-light border-0 p-3 mb-3">
                        <div class="text-xs text-uppercase text-muted fw-bold mb-1">Contexto Original</div>
                        <p class="text-sm text-dark m-0" id="detail-text" style="white-space: pre-wrap;">...</p>
                    </div>
                    <div class="mb-3">
                        <div class="text-xs text-uppercase text-muted fw-bold mb-2">Conexiones Directas</div>
                        <ul class="list-group list-group-flush bg-transparent" id="detail-connections">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- CONFIGURACIÓN VISUAL ---
    const COLORS = {
        entity: '#6366f1',
        concept: '#f59e0b',
        doc: '#10b981',
        inference: '#ef4444',
        bg: '#0f172a'
    };

    let network, allNodesData, allEdgesData;
    let currentSources = []; // Almacena las fuentes de la última respuesta del chat

    document.addEventListener('DOMContentLoaded', () => { loadGraph(); });

    // --- 1. MOTOR GRÁFICO (VIS.JS) ---
    async function loadGraph() {
        try {
            const res = await fetch('/api/graph');
            const data = await res.json();
            
            // Transformar para Vis
            const nodes = data.nodes.map(n => ({
                id: n.id,
                label: n.label,
                group: n.group,
                color: { 
                    background: n.group === 'Concept' ? COLORS.concept : COLORS.entity, 
                    border: 'rgba(255,255,255,0.3)',
                    highlight: { background: '#fff', border: COLORS.entity }
                },
                font: { color: '#cbd5e1', face: 'Outfit', size: 14, strokeWidth: 3, strokeColor: '#0f172a' },
                shape: 'dot',
                size: 20,
                shadow: true
            }));

            const edges = data.edges.map(e => ({
                from: e.from, to: e.to, label: e.label,
                color: { color: e.label.includes('INFERRED') ? COLORS.inference : 'rgba(148, 163, 184, 0.2)', opacity: 0.5 },
                dashes: e.label.includes('INFERRED'),
                arrows: 'to',
                font: { color: '#64748b', size: 10, align: 'middle', strokeWidth: 0, background: 'none' }
            }));

            const container = document.getElementById('network-container');
            const options = {
                nodes: { borderWidth: 2 },
                physics: {
                    forceAtlas2Based: { gravitationalConstant: -60, springLength: 150, damping: 0.9 },
                    solver: 'forceAtlas2Based',
                    stabilization: { iterations: 200 }
                },
                interaction: { hover: true, tooltipDelay: 200 }
            };

            network = new vis.Network(container, { nodes, edges }, options);
            
            // Guardar referencia para filtrado
            allNodesData = new vis.DataSet(nodes);
            allEdgesData = new vis.DataSet(edges);
            
            // Evento click nodo
            network.on("click", params => {
                if (params.nodes.length > 0) showNodeDetails(params.nodes[0]);
            });

        } catch(e) { console.error("Graph Error", e); }
    }

    // --- 2. INTERACCIÓN CHAT <-> GRAFO ---
    
    // Función llamada cuando el mouse entra en una cita [1]
    function highlightSource(index) {
        const source = currentSources.find(s => s.index === index);
        if(!source) return;

        const conceptIds = source.concepts;
        
        // Oscurecer todo
        const updateArray = [];
        allNodesData.forEach(node => {
            if(conceptIds.includes(node.id)) {
                // Nodo relevante: Resaltar
                updateArray.push({ id: node.id, opacity: 1, size: 30, color: { background: '#ef4444', border: '#fff' } });
            } else {
                // Nodo irrelevante: Difuminar
                updateArray.push({ id: node.id, opacity: 0.1, color: { background: '#334155' } });
            }
        });
        
        // Actualizar grafo
        network.body.data.nodes.update(updateArray);

        // Zoom si hay nodos
        if(conceptIds.length > 0) {
            network.fit({ nodes: conceptIds, animation: { duration: 500 } });
        }
        
        // Mostrar contenido en panel de detalles
        showSourceDetails(source);
    }

    function resetGraphHighlight() {
        const updateArray = [];
        allNodesData.forEach(node => {
            updateArray.push({ 
                id: node.id, 
                opacity: 1, 
                size: 20, 
                color: { background: node.group === 'Concept' ? COLORS.concept : COLORS.entity, border: 'rgba(255,255,255,0.3)' } 
            });
        });
        network.body.data.nodes.update(updateArray);
    }

    function showSourceDetails(source) {
        // Switch tab
        const tab = new bootstrap.Tab(document.querySelector('[data-bs-target="#tab-details"]'));
        tab.show();

        document.getElementById('details-placeholder').classList.add('d-none');
        document.getElementById('details-content').classList.remove('d-none');
        
        document.getElementById('detail-type').innerText = "FUENTE DOCUMENTAL";
        document.getElementById('detail-type').className = "badge bg-success rounded-pill";
        document.getElementById('detail-title').innerText = "Fragmento #" + source.index;
        document.getElementById('detail-text').innerText = source.short_content; // Aquí podrías poner el content completo si lo guardas
        
        const ul = document.getElementById('detail-connections');
        ul.innerHTML = source.concepts.map(c => 
            `<li class="list-group-item px-0 py-1"><i class="fa-solid fa-link text-xs me-2 opacity-50"></i>${c}</li>`
        ).join('');
    }

    function showNodeDetails(nodeId) {
        const node = allNodesData.get(nodeId);
        if(!node) return;

        // Switch tab
        const tab = new bootstrap.Tab(document.querySelector('[data-bs-target="#tab-details"]'));
        tab.show();
        
        document.getElementById('details-placeholder').classList.add('d-none');
        document.getElementById('details-content').classList.remove('d-none');
        
        document.getElementById('detail-type').innerText = node.group.toUpperCase();
        document.getElementById('detail-type').className = node.group === 'Concept' ? "badge bg-warning text-dark rounded-pill" : "badge bg-primary rounded-pill";
        document.getElementById('detail-title').innerText = node.label;
        document.getElementById('detail-text').innerText = "Entidad extraída del grafo de conocimiento.";
        
        // Buscar conexiones
        const connectedEdges = allEdgesData.get({ filter: e => e.from === nodeId || e.to === nodeId });
        const ul = document.getElementById('detail-connections');
        ul.innerHTML = connectedEdges.map(e => {
            const neighbor = e.from === nodeId ? e.to : e.from;
            return `<li class="list-group-item px-0 py-1 d-flex justify-content-between">
                        <span><i class="fa-solid fa-circle-nodes text-xs me-2"></i>${neighbor}</span>
                        <span class="text-xs text-muted border px-1 rounded">${e.label}</span>
                    </li>`;
        }).join('');
    }

    // --- 3. CHAT LOGIC ---
    function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } }
    
    async function sendChat() {
        const input = document.getElementById('userPrompt');
        const text = input.value.trim();
        if(!text) return;

        appendMsg('user', text);
        input.value = '';
        
        // Loading state
        const loadingId = 'loading-' + Date.now();
        document.getElementById('chatArea').insertAdjacentHTML('beforeend', 
            `<div id="${loadingId}" class="message-card message-ai text-muted"><i class="fa-solid fa-circle-notch fa-spin me-2"></i>Analizando vectores y grafo...</div>`);
        
        try {
            const res = await fetch('/api/chat', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: text}) 
            });
            const data = await res.json();
            document.getElementById(loadingId).remove();
            
            // Guardar fuentes para interactividad
            currentSources = data.sources || [];
            
            // Formatear respuesta (Markdown simple + Citas)
            let formatted = data.response
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Negrita
                .replace(/\n/g, '<br>')
                // Reemplazar [1], [2] con badges interactivos
                .replace(/\[(\d+)\]/g, (match, p1) => {
                    const idx = parseInt(p1);
                    return `<span class="citation-badge" 
                                onmouseenter="highlightSource(${idx})" 
                                onmouseleave="resetGraphHighlight()"
                                onclick="highlightSource(${idx})">${idx}</span>`;
                });

            appendMsg('ai', formatted);
            
        } catch(e) {
            document.getElementById(loadingId).remove();
            appendMsg('ai', `<span class="text-danger">Error de comunicación con el backend.</span>`);
        }
    }

    function appendMsg(role, html) {
        const area = document.getElementById('chatArea');
        const div = document.createElement('div');
        div.className = `message-card ${role === 'user' ? 'message-user' : 'message-ai'}`;
        
        if(role === 'ai') {
            div.innerHTML = `<div class="d-flex align-items-center gap-2 mb-2">
                                <i class="fa-solid fa-robot text-primary"></i>
                                <span class="fw-bold text-xs text-uppercase tracking-wide text-muted">LaMuralla</span>
                             </div>
                             <div class="md-content text-sm">${html}</div>`;
        } else {
            div.innerHTML = html;
        }
        
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    // --- 4. UTILS ---
    async function startIngestion() {
        // (Mismo código de ingesta que en tu versión anterior, 
        //  solo asegurándose de usar los nuevos IDs del layout)
        const btn = document.getElementById('btnIngest');
        const logDiv = document.getElementById('progressLog');
        const progressArea = document.getElementById('progressArea');
        
        // ... lógica de fetch /api/ingest ...
        // Simplificado para brevedad:
        const val = document.getElementById('ingestContent').value;
        if(!val) return alert("Escribe algo.");
        
        const formData = new FormData();
        formData.append('content', val);
        
        btn.disabled = true;
        progressArea.classList.remove('d-none');
        
        try {
             const response = await fetch('/api/ingest', { method: 'POST', body: formData });
             const reader = response.body.getReader();
             const decoder = new TextDecoder();
             while(true) {
                const { done, value } = await reader.read();
                if(done) break;
                logDiv.innerHTML += `> ${decoder.decode(value)}<br>`;
                logDiv.scrollTop = logDiv.scrollHeight;
             }
             btn.disabled = false;
             reloadGraph();
        } catch(e) { console.error(e); btn.disabled = false; }
    }

    function reloadGraph() { loadGraph(); }

    async function runReasoning() {
        const btn = document.getElementById('btnReasoning');
        const resDiv = document.getElementById('reasoningResult');
        btn.disabled = true;
        resDiv.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        try {
            const res = await fetch('/api/reasoning/run', { method: 'POST' });
            const data = await res.json();
            resDiv.innerHTML = `<span class="text-success">¡${data.length} inferencias!</span>`;
            if(data.length > 0) reloadGraph();
        } catch(e) {
            resDiv.innerHTML = 'Error.';
        } finally { btn.disabled = false; }
    }
</script>
{% endblock %}